#!/bin/bash

shopt -s globstar nullglob dotglob

output_filename="collected-nix.md"

if command -v tree &> /dev/null; then
    echo '' > "$output_filename"
    echo '```' >> "$output_filename"
    tree >> "$output_filename"
    echo '```' >> "$output_filename"
else
    echo "# Warning: 'tree' command not found. Install it for directory structure." > "$output_filename"
fi

first_file=true
find . -type f -name '*.nix' -print0 | sort -z | while IFS= read -r -d $'\0' file; do
    echo -e "\n" >> "$output_filename"
    echo "$file" >> "$output_filename"
    echo '```nix' >> "$output_filename"
    cat "$file" >> "$output_filename"
    # Add a newline if cat didn't output one from the file's end
    if [[ $(tail -c1 "$file" | wc -l) -eq 0 ]]; then
        echo >> "$output_filename"
    fi
    echo '```' >> "$output_filename"
done

echo "Generated file: $output_filename"
